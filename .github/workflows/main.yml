name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the master branch
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
  # Run this workflow when there is a push to teambit/bit master
  repository_dispatch:
    types: [ bit_master_push ]

env:
  BIT_TOKEN: ${{ secrets.BIT_TOKEN }}

jobs:
  # Test angular
  default-angular:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip-ci')"
    container:
      image: docker://bitcli/bit:latest
    steps:
      - uses: teambit/setup-action@v2.02
        with:
          name: angular-github-actions
          BIT_TOKEN: ${{ env.BIT_TOKEN }}

      - uses: actions/checkout@v2

      - name: Install ubuntu packages
        run: apt-get update && apt-get -y install sudo && sudo apt-get install -y libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libgconf-2-4 libnss3 libxss1 libasound2 libxtst6 xauth xvfb

      - name: Keep default
        run: npm i replace-in-file && node scripts/keep-env.js --version=15 --default

      - name: Remove v14
        run: bit remove versions/angular-v14 -s -f --log

      - name: Remove v13
        run: bit remove versions/angular-v13 -s -f --log

      - name: Remove v12
        run: bit remove versions/angular-v12 -s -f --log

      - name: Remove v11
        run: bit remove versions/angular-v11 -s -f --log

      - name: Remove v10
        run: bit remove versions/angular-v10 -s -f --log

      - name: Remove v9
        run: bit remove versions/angular-v9 -s -f --log

      - name: Remove v8
        run: bit remove versions/angular-v8 -s -f --log

      - name: Add example component
        run: bit add examples/demo-lib --log

      - name: Add example app
        run: bit add examples/demo-app --log

      - name: Install dependencies
        run: bit install --log

      # Compile the aspects
      - name: Bit compile aspects
        run: bit compile --log

      # Run bit link to regenerate the package.json of the example component
      - name: Bit link
        run: bit link --log

      # Compile the example component
      - name: Bit compile example component
        run: bit compile demo-lib --log

      # Compile the example app
      - name: Bit compile example app
        run: bit compile demo-app --log

      - name: Bit test
        run: bit test --log

      - name: Bit build
        run: bit build --log

      - uses: actions/upload-artifact@v2
        with:
          name: debug-log
          path: $HOME/Library/Caches/Bit/logs

  # Test angular-v15
  v15:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip-ci')"
    container:
      image: docker://bitcli/bit:latest
    steps:
      - uses:  teambit/setup-action@v1
        with:
          name: angular-github-actions
          BIT_TOKEN: ${{ env.BIT_TOKEN }}

      - uses: actions/checkout@v2

      - name: Keep v15
        run: npm i replace-in-file && node scripts/keep-env.js --version=14

      - name: Remove default
        run: bit remove angular -s -f --log

      - name: Remove v14
        run: bit remove versions/angular-v14 -s -f --log

      - name: Remove v13
        run: bit remove versions/angular-v13 -s -f --log

      - name: Remove v12
        run: bit remove versions/angular-v12 -s -f --log

      - name: Remove v11
        run: bit remove versions/angular-v11 -s -f --log

      - name: Remove v10
        run: bit remove versions/angular-v10 -s -f --log

      - name: Remove v9
        run: bit remove versions/angular-v9 -s -f --log

      - name: Remove v8
        run: bit remove versions/angular-v8 -s -f --log

      - name: Add example component
        run: bit add examples/demo-lib-v15 --log

      - name: Install dependencies
        run: bit install --log

      # Compile the aspects
      - name: Bit compile aspects
        run: bit compile --log

      # Run bit link to regenerate the package.json of the example component
      - name: Bit link
        run: bit link --log

      # Compile the example component
      - name: Bit compile example
        run: bit compile demo-lib-v15 --log

      - name: Bit test
        run: bit test --log

      - name: Bit build
        run: bit build --log

      - uses: actions/upload-artifact@v2
        with:
          name: debug-log
          path: $HOME/Library/Caches/Bit/logs

  # Test angular-v14
  v14:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip-ci')"
    container:
      image: docker://bitcli/bit:latest
    steps:
      - uses:  teambit/setup-action@v1
        with:
          name: angular-github-actions
          BIT_TOKEN: ${{ env.BIT_TOKEN }}

      - uses: actions/checkout@v2

      - name: Keep v14
        run: npm i replace-in-file && node scripts/keep-env.js --version=14

      - name: Remove default
        run: bit remove angular -s -f --log

      - name: Remove v15
        run: bit remove versions/angular-v15 -s -f --log

      - name: Remove v13
        run: bit remove versions/angular-v13 -s -f --log

      - name: Remove v12
        run: bit remove versions/angular-v12 -s -f --log

      - name: Remove v11
        run: bit remove versions/angular-v11 -s -f --log

      - name: Remove v10
        run: bit remove versions/angular-v10 -s -f --log

      - name: Remove v9
        run: bit remove versions/angular-v9 -s -f --log

      - name: Remove v8
        run: bit remove versions/angular-v8 -s -f --log

      - name: Add example component
        run: bit add examples/demo-lib-v14 --log

      - name: Install dependencies
        run: bit install --log

      # Compile the aspects
      - name: Bit compile aspects
        run: bit compile --log

      # Run bit link to regenerate the package.json of the example component
      - name: Bit link
        run: bit link --log

      # Compile the example component
      - name: Bit compile example
        run: bit compile demo-lib-v14 --log

      - name: Bit test
        run: bit test --log

      - name: Bit build
        run: bit build --log

      - uses: actions/upload-artifact@v2
        with:
          name: debug-log
          path: $HOME/Library/Caches/Bit/logs

  # Test angular-v13
  v13:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip-ci')"
    container:
      image: docker://bitcli/bit:latest
    steps:
      - uses:  teambit/setup-action@v2.02
        with:
          name: angular-github-actions
          BIT_TOKEN: ${{ env.BIT_TOKEN }}

      - uses: actions/checkout@v2

      - name: Keep v13
        run: npm i replace-in-file && node scripts/keep-env.js --version=13

      - name: Remove default
        run: bit remove angular -s -f --log

      - name: Remove v15
        run: bit remove versions/angular-v15 -s -f --log

      - name: Remove v14
        run: bit remove versions/angular-v14 -s -f --log

      - name: Remove v12
        run: bit remove versions/angular-v12 -s -f --log

      - name: Remove v11
        run: bit remove versions/angular-v11 -s -f --log

      - name: Remove v10
        run: bit remove versions/angular-v10 -s -f --log

      - name: Remove v9
        run: bit remove versions/angular-v9 -s -f --log

      - name: Remove v8
        run: bit remove versions/angular-v8 -s -f --log

      - name: Add example component
        run: bit add examples/demo-lib-v13 --log

      - name: Install dependencies
        run: bit install --log

      # Compile the aspects
      - name: Bit compile aspects
        run: bit compile --log

      # Run bit link to regenerate the package.json of the example component
      - name: Bit link
        run: bit link --log

      # Compile the example component
      - name: Bit compile example
        run: bit compile demo-lib-v13 --log

      - name: Bit test
        run: bit test --log

      - name: Bit build
        run: bit build --log

      - uses: actions/upload-artifact@v2
        with:
          name: debug-log
          path: $HOME/Library/Caches/Bit/logs

# Test angular-v12
  v12:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip-ci')"
    container:
      image: docker://bitcli/bit:latest
    steps:
      - uses:  teambit/setup-action@v2.02
        with:
          name: angular-github-actions
          BIT_TOKEN: ${{ env.BIT_TOKEN }}

      - uses: actions/checkout@v2

      - name: Keep v12
        run: npm i replace-in-file && node scripts/keep-env.js --version=12

      - name: Remove default
        run: bit remove angular -s -f --log

      - name: Remove v15
        run: bit remove versions/angular-v15 -s -f --log

      - name: Remove v14
        run: bit remove versions/angular-v14 -s -f --log

      - name: Remove v13
        run: bit remove versions/angular-v13 -s -f --log

      - name: Remove v11
        run: bit remove versions/angular-v11 -s -f --log

      - name: Remove v10
        run: bit remove versions/angular-v10 -s -f --log

      - name: Remove v9
        run: bit remove versions/angular-v9 -s -f --log

      - name: Remove v8
        run: bit remove versions/angular-v8 -s -f --log

      - name: Add example component
        run: bit add examples/demo-lib-v12 --log

      - name: Install dependencies
        run: bit install --log

      # Compile the aspects
      - name: Bit compile aspects
        run: bit compile --log

      # Run bit link to regenerate the package.json of the example component
      - name: Bit link
        run: bit link --log

      # Compile the example component
      - name: Bit compile example
        run: bit compile demo-lib-v12 --log

      - name: Bit test
        run: bit test --log

      - name: Bit build
        run: bit build --log

      - uses: actions/upload-artifact@v2
        with:
          name: debug-log
          path: $HOME/Library/Caches/Bit/logs

  # Test angular-v11
  v11:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip-ci')"
    container:
      image: docker://bitcli/bit:latest
    steps:
      - uses:  teambit/setup-action@v2.02
        with:
          name: angular-github-actions
          BIT_TOKEN: ${{ env.BIT_TOKEN }}

      - uses: actions/checkout@v2

      - name: Keep v11
        run: npm i replace-in-file && node scripts/keep-env.js --version=11

      - name: Remove default
        run: bit remove angular -s -f --log

      - name: Remove v15
        run: bit remove versions/angular-v15 -s -f --log

      - name: Remove v14
        run: bit remove versions/angular-v14 -s -f --log

      - name: Remove v13
        run: bit remove versions/angular-v13 -s -f --log

      - name: Remove v12
        run: bit remove versions/angular-v12 -s -f

      - name: Remove v10
        run: bit remove versions/angular-v10 -s -f

      - name: Remove v9
        run: bit remove versions/angular-v9 -s -f

      - name: Remove v8
        run: bit remove versions/angular-v8 -s -f

      - name: Add example component
        run: bit add examples/demo-lib-v11

      - name: Install dependencies
        run: bit install

      # Compile the aspects
      - name: Bit compile aspects
        run: bit compile --log

      # Run bit link to regenerate the package.json of the example component
      - name: Bit link
        run: bit link

      # Compile the example component
      - name: Bit compile example
        run: bit compile demo-lib-v11 --log

      - name: Bit test
        run: bit test --log

      - name: Bit build
        run: bit build --log

      - uses: actions/upload-artifact@v2
        with:
          name: debug-log
          path: $HOME/Library/Caches/Bit/logs

  # Test angular-v10
  v10:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip-ci')"
    container:
      image: docker://bitcli/bit:latest
    steps:
      - uses:  teambit/setup-action@v2.02
        with:
          name: angular-github-actions
          BIT_TOKEN: ${{ env.BIT_TOKEN }}

      - uses: actions/checkout@v2

      - name: Keep v10
        run: npm i replace-in-file && node scripts/keep-env.js --version=10

      - name: Remove default
        run: bit remove angular -s -f --log

      - name: Remove v15
        run: bit remove versions/angular-v15 -s -f --log

      - name: Remove v14
        run: bit remove versions/angular-v14 -s -f --log

      - name: Remove v13
        run: bit remove versions/angular-v13 -s -f --log

      - name: Remove v12
        run: bit remove versions/angular-v12 -s -f

      - name: Remove v11
        run: bit remove versions/angular-v11 -s -f

      - name: Remove v9
        run: bit remove versions/angular-v9 -s -f

      - name: Remove v8
        run: bit remove versions/angular-v8 -s -f

      - name: Add example component
        run: bit add examples/demo-lib-v10

      - name: Install dependencies
        run: bit install

      # Compile the aspects
      - name: Bit compile aspects
        run: bit compile --log

      # Run bit link to regenerate the package.json of the example component
      - name: Bit link
        run: bit link

      # Compile the example component
      - name: Bit compile example
        run: bit compile demo-lib-v10 --log

      - name: Bit test
        run: bit test --log

      - name: Bit build
        run: bit build --log

      - uses: actions/upload-artifact@v2
        with:
          name: debug-log
          path: $HOME/Library/Caches/Bit/logs

  # Test angular-v9
  v9:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip-ci')"
    container:
      image: docker://bitcli/bit:latest
    steps:
      - uses:  teambit/setup-action@v2.02
        with:
          name: angular-github-actions
          BIT_TOKEN: ${{ env.BIT_TOKEN }}

      - uses: actions/checkout@v2

      - name: Keep v9
        run: npm i replace-in-file && node scripts/keep-env.js --version=9

      - name: Remove default
        run: bit remove angular -s -f --log

      - name: Remove v15
        run: bit remove versions/angular-v15 -s -f --log

      - name: Remove v14
        run: bit remove versions/angular-v14 -s -f --log

      - name: Remove v13
        run: bit remove versions/angular-v13 -s -f --log

      - name: Remove v12
        run: bit remove versions/angular-v12 -s -f

      - name: Remove v11
        run: bit remove versions/angular-v11 -s -f

      - name: Remove v10
        run: bit remove versions/angular-v10 -s -f

      - name: Remove v8
        run: bit remove versions/angular-v8 -s -f

      - name: Add example component
        run: bit add examples/demo-lib-v9

      - name: Install dependencies
        run: bit install

      # Compile the aspects
      - name: Bit compile aspects
        run: bit compile --log

      # Run bit link to regenerate the package.json of the example component
      - name: Bit link
        run: bit link

      # Compile the example component
      - name: Bit compile example
        run: bit compile demo-lib-v9 --log

      - name: Bit test
        run: bit test --log

      - name: Bit build
        run: bit build --log

      - uses: actions/upload-artifact@v2
        with:
          name: debug-log
          path: $HOME/Library/Caches/Bit/logs

  # Test angular-v8
  v8:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip-ci')"
    container:
      image: docker://bitcli/bit:latest
    steps:
      - uses:  teambit/setup-action@v2.02
        with:
          name: angular-github-actions
          BIT_TOKEN: ${{ env.BIT_TOKEN }}

      - uses: actions/checkout@v2

      - name: Keep v8
        run: npm i replace-in-file && node scripts/keep-env.js --version=8

      - name: Remove default
        run: bit remove angular -s -f --log

      - name: Remove v15
        run: bit remove versions/angular-v15 -s -f --log

      - name: Remove v14
        run: bit remove versions/angular-v14 -s -f --log

      - name: Remove v13
        run: bit remove versions/angular-v13 -s -f --log

      - name: Remove v12
        run: bit remove versions/angular-v12 -s -f

      - name: Remove v11
        run: bit remove versions/angular-v11 -s -f

      - name: Remove v10
        run: bit remove versions/angular-v10 -s -f

      - name: Remove v9
        run: bit remove versions/angular-v9 -s -f

      - name: Add example component
        run: bit add examples/demo-lib-v8

      - name: Install dependencies
        run: bit install

      # Compile the aspects
      - name: Bit compile aspects
        run: bit compile --log

      # Run bit link to regenerate the package.json of the example component
      - name: Bit link
        run: bit link

      # Compile the example component
      - name: Bit compile example
        run: bit compile demo-lib-v8 --log

      - name: Bit test
        run: bit test --log

      - name: Bit build
        run: bit build --log

      - uses: actions/upload-artifact@v2
        with:
          name: debug-log
          path: $HOME/Library/Caches/Bit/logs
