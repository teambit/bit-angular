name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the master branch
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
  # Run this workflow when there is a push to teambit/bit master
  repository_dispatch:
    types: [ bit_master_push ]

env:
  BIT_TOKEN: ${{ secrets.BIT_TOKEN }}

jobs:
  # Test angular
  default-angular:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip-ci')"
    container:
      image: bitsrc/stable:latest
    steps:
      - uses: actions/checkout@v3

      - name: Keep default
        run: npm i replace-in-file@6.3.5 json5@2.2.3 && node scripts/keep-env.js --version=16 --default

      - name: Cleanup node modules
        run: rm -rf node_modules

      - name: Install dependencies
        run: bit install --log

      - name: Add example component
        run: bit add integration/demo-lib --log

      - name: Add example app
        run: bit add integration/demo-app --log

      - name: Use example app
        run: bit use integration.examples/demo-app --log

      - name: Install dependencies
        run: bit install --log

      # Compile the example app
      - name: Bit compile example app
        run: bit compile demo-app --log

      - name: Bit test
        run: bit test --log

      - name: Bit build
        run: bit build --log

      - uses: actions/upload-artifact@v3
        with:
          name: debug-log
          path: $HOME/Library/Caches/Bit/logs

  # Test angular-v17
  v17:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip-ci')"
    container:
      image: bitsrc/stable:latest
    steps:
      - uses: actions/checkout@v3

      - name: Keep v17
        run: npm i replace-in-file@6.3.5 json5@2.2.3 && node scripts/keep-env.js --version=17

      - name: Cleanup node modules
        run: rm -rf node_modules

      - name: Install dependencies
        run: bit install --log

      - name: Add example component
        run: bit add integration/demo-lib-v17 --log

      - name: Install dependencies
        run: bit install --log

      - name: Bit test
        run: bit test --log

      - name: Bit build
        run: bit build --log

      - uses: actions/upload-artifact@v3
        with:
          name: debug-log
          path: $HOME/Library/Caches/Bit/logs

  # Test angular-v16
  v16:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip-ci')"
    container:
      image: bitsrc/stable:latest
    steps:
      - uses: actions/checkout@v3

      - name: Keep v16
        run: npm i replace-in-file@6.3.5 json5@2.2.3 && node scripts/keep-env.js --version=16

      - name: Cleanup node modules
        run: rm -rf node_modules

      - name: Install dependencies
        run: bit install --log

      - name: Add example component
        run: bit add integration/demo-lib-v16 --log

      - name: Install dependencies
        run: bit install --log

      - name: Bit test
        run: bit test --log

      - name: Bit build
        run: bit build --log

      - uses: actions/upload-artifact@v3
        with:
          name: debug-log
          path: $HOME/Library/Caches/Bit/logs


  # Test angular-v15
  v15:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip-ci')"
    container:
      image: bitsrc/stable:latest
    steps:
      - uses: actions/checkout@v3

      - name: Keep v15
        run: npm i replace-in-file@6.3.5 json5@2.2.3 && node scripts/keep-env.js --version=15

      - name: Cleanup node modules
        run: rm -rf node_modules

      - name: Install dependencies
        run: bit install --log

      - name: Add example component
        run: bit add integration/demo-lib-v15 --log

      - name: Install dependencies
        run: bit install --log

      - name: Bit test
        run: bit test --log

      - name: Bit build
        run: bit build --log

      - uses: actions/upload-artifact@v3
        with:
          name: debug-log
          path: $HOME/Library/Caches/Bit/logs

  # Test angular-v14
  v14:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip-ci')"
    container:
      image: bitsrc/stable:latest
    steps:
      - uses: actions/checkout@v3

      - name: Keep v14
        run: npm i replace-in-file@6.3.5 json5@2.2.3 && node scripts/keep-env.js --version=14

      - name: Cleanup node modules
        run: rm -rf node_modules

      - name: Install dependencies
        run: bit install --log

      - name: Add example component
        run: bit add integration/demo-lib-v14 --log

      - name: Install dependencies
        run: bit install --log

      - name: Bit test
        run: bit test --log

      - name: Bit build
        run: bit build --log

      - uses: actions/upload-artifact@v3
        with:
          name: debug-log
          path: $HOME/Library/Caches/Bit/logs

  # Test angular-v13
  v13:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip-ci')"
    container:
      image: bitsrc/stable:latest
    steps:
      - uses: actions/checkout@v3

      - name: Keep v13
        run: npm i replace-in-file@6.3.5 json5@2.2.3 && node scripts/keep-env.js --version=13

      - name: Cleanup node modules
        run: rm -rf node_modules

      - name: Install dependencies
        run: bit install --log

      - name: Add example component
        run: bit add integration/demo-lib-v13 --log

      - name: Install dependencies
        run: bit install --log

      - name: Bit test
        run: bit test --log

      - name: Bit build
        run: bit build --log

      - uses: actions/upload-artifact@v3
        with:
          name: debug-log
          path: $HOME/Library/Caches/Bit/logs
