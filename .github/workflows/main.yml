name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the master branch
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
  # Run this workflow when there is a push to teambit/bit master
  repository_dispatch:
    types: [ bit_master_push ]

env:
  BIT_TOKEN: ${{ secrets.BIT_TOKEN }}

jobs:
  # Test angular
  default-angular:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip-ci')"
    container:
      image: docker://bitcli/bit:latest-node-16.15.0
    steps:
      - uses: teambit/setup-action@v2.02
        with:
          name: angular-github-actions
          BIT_TOKEN: ${{ env.BIT_TOKEN }}

      - uses: actions/checkout@v3

      - name: Keep default
        run: npm i replace-in-file && node scripts/keep-env.js --version=16 --default

      - name: Cleanup node modules
        run: rm -rf node_modules

      - name: Install dependencies
        run: bit install --log

      - name: Remove v15
        run: bit remove versions/angular-v15 -s -f --log

      - name: Remove v15 fork
        run: bit remove forks/angular-env-v15 -s -f --log

      - name: Remove v14
        run: bit remove versions/angular-v14 -s -f --log

      - name: Remove v14 fork
        run: bit remove forks/angular-env-v14 -s -f --log

      - name: Remove v13
        run: bit remove versions/angular-v13 -s -f --log

      - name: Remove v13 fork
        run: bit remove forks/angular-env-v13 -s -f --log

      - name: Remove v12
        run: bit remove versions/angular-v12 -s -f --log

      - name: Remove v12 fork
        run: bit remove forks/angular-env-v12 -s -f --log

      - name: Add example component
        run: bit add examples/demo-lib --log

      - name: Add example app
        run: bit add examples/demo-app --log

      - name: Cleanup node modules
        run: bit cc

      - name: Cleanup node modules
        run: bit capsule delete --all

      - name: Cleanup node modules
        run: rm -rf node_modules

      - name: Cleanup node modules
        run: rm -rf package-lock.json

      - name: Cleanup node modules
        run: rm -rf .git/bit

      - name: Install dependencies
        run: bit install --log

      # Compile the example app
      - name: Bit compile example app
        run: bit compile demo-app --log

      - name: Bit test
        run: bit test --log

      - name: Bit build
        run: bit build --log

      - uses: actions/upload-artifact@v3
        with:
          name: debug-log
          path: $HOME/Library/Caches/Bit/logs

  # Test angular-v16
  v16:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip-ci')"
    container:
      image: docker://bitcli/bit:latest-node-16.15.0
    steps:
      - uses:  teambit/setup-action@v2.02
        with:
          name: angular-github-actions
          BIT_TOKEN: ${{ env.BIT_TOKEN }}

      - uses: actions/checkout@v3

      - name: Keep v16
        run: npm i replace-in-file && node scripts/keep-env.js --version=16

      - name: Cleanup node modules
        run: rm -rf node_modules

      - name: Install dependencies
        run: bit install --log

      - name: Remove default
        run: bit remove angular -s -f --log

      - name: Remove default fork
        run: bit remove forks/angular-env -s -f --log

      - name: Remove v15
        run: bit remove versions/angular-v15 -s -f --log

      - name: Remove v15 fork
        run: bit remove forks/angular-env-v15 -s -f --log

      - name: Remove v14
        run: bit remove versions/angular-v14 -s -f --log

      - name: Remove v14 fork
        run: bit remove forks/angular-env-v14 -s -f --log

      - name: Remove v13
        run: bit remove versions/angular-v13 -s -f --log

      - name: Remove v13 fork
        run: bit remove forks/angular-env-v13 -s -f --log

      - name: Remove v12
        run: bit remove versions/angular-v12 -s -f --log

      - name: Remove v12 fork
        run: bit remove forks/angular-env-v12 -s -f --log

      - name: Add example component
        run: bit add examples/demo-lib-v16 --log

      - name: Cleanup node modules
        run: bit cc

      - name: Cleanup node modules
        run: bit capsule delete --all

      - name: Cleanup node modules
        run: rm -rf node_modules

      - name: Cleanup node modules
        run: rm -rf package-lock.json

      - name: Cleanup node modules
        run: rm -rf .git/bit

      - name: Install dependencies
        run: bit install --log

      - name: Bit test
        run: bit test --log

      - name: Bit build
        run: bit build --log

      - uses: actions/upload-artifact@v3
        with:
          name: debug-log
          path: $HOME/Library/Caches/Bit/logs


  # Test angular-v15
  v15:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip-ci')"
    container:
      image: docker://bitcli/bit:latest-node-16.15.0
    steps:
      - uses:  teambit/setup-action@v2.02
        with:
          name: angular-github-actions
          BIT_TOKEN: ${{ env.BIT_TOKEN }}

      - uses: actions/checkout@v3

      - name: Keep v15
        run: npm i replace-in-file && node scripts/keep-env.js --version=15

      - name: Cleanup node modules
        run: rm -rf node_modules

      - name: Install dependencies
        run: bit install --log

      - name: Remove default
        run: bit remove angular -s -f --log

      - name: Remove default fork
        run: bit remove forks/angular-env -s -f --log

      - name: Remove v16
        run: bit remove versions/angular-v16 -s -f --log

      - name: Remove v16 fork
        run: bit remove forks/angular-env-v16 -s -f --log

      - name: Remove v14
        run: bit remove versions/angular-v14 -s -f --log

      - name: Remove v14 fork
        run: bit remove forks/angular-env-v14 -s -f --log

      - name: Remove v13
        run: bit remove versions/angular-v13 -s -f --log

      - name: Remove v13 fork
        run: bit remove forks/angular-env-v13 -s -f --log

      - name: Remove v12
        run: bit remove versions/angular-v12 -s -f --log

      - name: Remove v12 fork
        run: bit remove forks/angular-env-v12 -s -f --log

      - name: Add example component
        run: bit add examples/demo-lib-v15 --log

      - name: Cleanup node modules
        run: bit cc

      - name: Cleanup node modules
        run: bit capsule delete --all

      - name: Cleanup node modules
        run: rm -rf node_modules

      - name: Cleanup node modules
        run: rm -rf package-lock.json

      - name: Cleanup node modules
        run: rm -rf .git/bit

      - name: Install dependencies
        run: bit install --log

      - name: Bit test
        run: bit test --log

      - name: Bit build
        run: bit build --log

      - uses: actions/upload-artifact@v3
        with:
          name: debug-log
          path: $HOME/Library/Caches/Bit/logs

  # Test angular-v14
  v14:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip-ci')"
    container:
      image: docker://bitcli/bit:latest-node-16.15.0
    steps:
      - uses:  teambit/setup-action@v2.02
        with:
          name: angular-github-actions
          BIT_TOKEN: ${{ env.BIT_TOKEN }}

      - uses: actions/checkout@v3

      - name: Keep v14
        run: npm i replace-in-file && node scripts/keep-env.js --version=14

      - name: Cleanup node modules
        run: rm -rf node_modules

      - name: Install dependencies
        run: bit install --log

      - name: Remove default
        run: bit remove angular -s -f --log

      - name: Remove default fork
        run: bit remove forks/angular-env -s -f --log

      - name: Remove v16
        run: bit remove versions/angular-v16 -s -f --log

      - name: Remove v16 fork
        run: bit remove forks/angular-env-v16 -s -f --log

      - name: Remove v15
        run: bit remove versions/angular-v15 -s -f --log

      - name: Remove v15 fork
        run: bit remove forks/angular-env-v15 -s -f --log

      - name: Remove v13
        run: bit remove versions/angular-v13 -s -f --log

      - name: Remove v13 fork
        run: bit remove forks/angular-env-v13 -s -f --log

      - name: Remove v12
        run: bit remove versions/angular-v12 -s -f --log

      - name: Remove v12 fork
        run: bit remove forks/angular-env-v12 -s -f --log

      - name: Add example component
        run: bit add examples/demo-lib-v14 --log

      - name: Cleanup node modules
        run: bit cc

      - name: Cleanup node modules
        run: bit capsule delete --all

      - name: Cleanup node modules
        run: rm -rf node_modules

      - name: Cleanup node modules
        run: rm -rf package-lock.json

      - name: Cleanup node modules
        run: rm -rf .git/bit

      - name: Install dependencies
        run: bit install --log

      - name: Bit test
        run: bit test --log

      - name: Bit build
        run: bit build --log

      - uses: actions/upload-artifact@v3
        with:
          name: debug-log
          path: $HOME/Library/Caches/Bit/logs

  # Test angular-v13
  v13:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip-ci')"
    container:
      image: docker://bitcli/bit:latest-node-16.15.0
    steps:
      - uses:  teambit/setup-action@v2.02
        with:
          name: angular-github-actions
          BIT_TOKEN: ${{ env.BIT_TOKEN }}

      - uses: actions/checkout@v3

      - name: Keep v13
        run: npm i replace-in-file && node scripts/keep-env.js --version=13

      - name: Cleanup node modules
        run: rm -rf node_modules

      - name: Install dependencies
        run: bit install --log

      - name: Remove default
        run: bit remove angular -s -f --log

      - name: Remove default fork
        run: bit remove forks/angular-env -s -f --log

      - name: Remove v16
        run: bit remove versions/angular-v16 -s -f --log

      - name: Remove v16 fork
        run: bit remove forks/angular-env-v16 -s -f --log

      - name: Remove v15
        run: bit remove versions/angular-v15 -s -f --log

      - name: Remove v15 fork
        run: bit remove forks/angular-env-v15 -s -f --log

      - name: Remove v14
        run: bit remove versions/angular-v14 -s -f --log

      - name: Remove v14 fork
        run: bit remove forks/angular-env-v14 -s -f --log

      - name: Remove v12
        run: bit remove versions/angular-v12 -s -f --log

      - name: Remove v12 fork
        run: bit remove forks/angular-env-v12 -s -f --log

      - name: Add example component
        run: bit add examples/demo-lib-v13 --log

      - name: Cleanup node modules
        run: bit cc

      - name: Cleanup node modules
        run: bit capsule delete --all

      - name: Cleanup node modules
        run: rm -rf node_modules

      - name: Cleanup node modules
        run: rm -rf package-lock.json

      - name: Cleanup node modules
        run: rm -rf .git/bit

      - name: Install dependencies
        run: bit install --log

      - name: Bit test
        run: bit test --log

      - name: Bit build
        run: bit build --log

      - uses: actions/upload-artifact@v3
        with:
          name: debug-log
          path: $HOME/Library/Caches/Bit/logs


  # Test angular-v12
  v12:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip-ci')"
    container:
      image: docker://bitcli/bit:latest-node-16.15.0
    steps:
      - uses:  teambit/setup-action@v2.02
        with:
          name: angular-github-actions
          BIT_TOKEN: ${{ env.BIT_TOKEN }}

      - uses: actions/checkout@v3

      - name: Keep v12
        run: npm i replace-in-file && node scripts/keep-env.js --version=12

      - name: Cleanup node modules
        run: rm -rf node_modules

      - name: Install dependencies
        run: bit install --log

      - name: Remove default
        run: bit remove angular -s -f --log

      - name: Remove default fork
        run: bit remove forks/angular-env -s -f --log

      - name: Remove v16
        run: bit remove versions/angular-v16 -s -f --log

      - name: Remove v16 fork
        run: bit remove forks/angular-env-v16 -s -f --log

      - name: Remove v15
        run: bit remove versions/angular-v15 -s -f --log

      - name: Remove v15 fork
        run: bit remove forks/angular-env-v15 -s -f --log

      - name: Remove v14
        run: bit remove versions/angular-v14 -s -f --log

      - name: Remove v14 fork
        run: bit remove forks/angular-env-v14 -s -f --log

      - name: Remove v13
        run: bit remove versions/angular-v13 -s -f --log

      - name: Remove v13 fork
        run: bit remove forks/angular-env-v13 -s -f --log

      - name: Add example component
        run: bit add examples/demo-lib-v12 --log

      - name: Cleanup node modules
        run: bit cc

      - name: Cleanup node modules
        run: bit capsule delete --all

      - name: Cleanup node modules
        run: rm -rf node_modules

      - name: Cleanup node modules
        run: rm -rf package-lock.json

      - name: Cleanup node modules
        run: rm -rf .git/bit

      - name: Install dependencies
        run: bit install --log

      - name: Bit test
        run: bit test --log

      - name: Bit build
        run: bit build --log

      - uses: actions/upload-artifact@v3
        with:
          name: debug-log
          path: $HOME/Library/Caches/Bit/logs
